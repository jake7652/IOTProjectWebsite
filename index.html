<!DOCTYPE html>
<html>
<!-- offline source for jquery used for calling php script from javascript -->
<script src="jquery-3.3.1.js"></script>
<script src="/jquery-ui/jquery-ui.min.js"></script>
<link rel="stylesheet" href="/jquery-ui/jquery-ui.min.css">
<script src="/DataTables/datatables.min.js"></script>
<link rel="stylesheet" href="/DataTables/datatables.min.css">
<script src="/jquery-loading-overlay-2.1.5/dist/loadingoverlay.min.js"></script>

<head>
<!-- Styling for the graph button and the reset button -->
<style>




legend {
font-size: 20px;
position:relative;


}

.ui-slider-horizontal {
width:41%;
height: 100%;
display:block;
float:left;
padding-bottom: 5px;
padding-top: 5px;
}

.ui-slider .ui-slider-handle {
height: 130%;
width: 4%;
padding-left: 5px;

}

.graphbutton { 
display: block;
border: none;
width: 100%;
background-color: #4CAF50;
font-size: 16px;
cursor: pointer;
text-align: center;

}
.graphbutton:hover {
    background-color: #ddd;
    color: black;
}

.resetbutton { 
display: block;
border: none;
width: 100%;
height: 50px;
background-color: #f6931f;
font-size: 16px;
cursor: pointer;
text-align: center;

}
.resetbutton:hover {
    background-color: #ddd;
    color: black;
}

.divLeft {
width:41%;
height: 100%;
display:block;
float:left;

}

.divRight {
width: 41%;
height: 100%;
display:block;
float: left;

}

.separator {
width: 1%;
display:inline;
float: left;
}

</style>
</head>
<body>


<!-- label for the table -->
<p style="text-align: center; font-size: 24px;">Realtime sensor readings table</p>

<!-- manually add the headers for each column but nothing else -->
<table id="sensorsTable" class="display" style="width:100%">
  <thead>
  <tr>
    <th>Sensor</th>
    <th>Value</th>
    <th>Unit</th>
    <th>Date</th>
    <th>Graph</th>
  </tr>
</thead>
<tbody>


</tbody>
</table>
<br>
<!-- Label for the sliders for viewing older sensor data -->


<form style="height:50%;">

<fieldset style="height:50%;">
<!-- Date slider label  -->
<legend> Select older sensor data to view  </legend>

<div style="width:100%; display:block; height:70%"> 
  <div class = "divLeft">
  <label for="amount" style:"width:50%;">Date of reading:</label> 
  <input type="text" id="amount" style="border: 0; color: #f6931f; font-weight: bold; " />
  </div>
  <span class = "separator"><br></span>
  <div class = "divRight">
  <label for="hoursmins" style="display:block; float:left;">Time of reading: <br></label>
  <input type="text" id="hoursmins" style="border: 0; color: #f6931f; font-weight: bold; " />  
  </div>
</div>


<span class = "separator" style="height:10px; width:100%"><br></span>

<!-- div on which the date slider is drawn for scrubbing through days -->

<div style="display:block; height: 10px;"> 

<div id="slider-range" ></div>

<span class = "separator"><br></span>
 
<!-- Time slider label -->
<!-- div on which the time sliders is draw for scrubbing through hours mins seconds -->
<div id="slider-range-hours" ></div>


<span class = "separator" style="height: 10px;"><br></span>

<input type='button' class="graphbutton" id='prevData' style="display:inline; width:15%; float:left; font-size:17px" value='Get values at time' onClick='oldDataReq()'>

</div>
<span class = "separator" style="height:10px; width:100%"><br></span>

</fieldset>
<br>
</form>

<script>



//$.LoadingOverlay("show");

var UNITS = { //Labels of the units that each sensor uses
HumidityTemperature: "F",
PressureTemperature: "F",
Humidity: "% Saturation",
HumidityHeatIndex: "F",
Transducer: "mm",
PressurePressure: "Hg/mm",
PressureAlititude: "FT", 
Temperature1: "F",

};
var LABELS  = { //labels for each sensor as it appears in the first column
HumidityTemperature: "Humidity Temperature",
PressureTemperature: "Pressure Temperature",
Humidity: "Humidity",
HumidityHeatIndex: "Heat Index",
Transducer: "Distance",
PressurePressure: "Pressure",
PressureAlititude: "Altitude", 
Temperature1: "Water Temperature",

};

//ajax call using jquery to TableReq req for the fields in the database for N lines. This is for inital table data calls 
function getFromSql(field,lines,callback) {
var ret = null;
	 $.ajax({ url: "TableReq.php",
         async: true,
	 type: "POST",
         dataType: 'json',
	 data: {arguments: []}, //the line argument is not actually passed in and is just a holdover from another function
         success: function(output) {
	 	  
		    callback(output);
		    
}
		
});
return ret; //return the result of the ajax call
}


//converts the format that the SQL table uses to store time into the format that the table uses to display it
function sqlToTable(date) {

return "".concat (date.substring(0,4), "-" , date.substring(4,6) ,"-" , date.substring(6,8) ," " ,date.substring(8,10) ,":" ,date.substring(10,12) ,":" ,date.substring(12,14));
}

//converts the format that the table uses to display time to the format that our SQL table uses to store it
function tableToSql(date) {

return "".concat(date.substring(0,4),date.substring(5,7),date.substring(8,10),date.substring(11,13),date.substring(14,16),date.substring(17,19));

}
//conversion from the format that the slider uses to display time to the format our SQL table uses to store time
function sliderToSql(date,time) {

//have to do some formatting using concat and some nested condensed if elses
return "".concat(date.getFullYear(),(((date.getMonth()+1)<10) ? '0' + (date.getMonth()+1) : (date.getMonth()+1)),((date.getDate()<10) ? '0' +date.getDate() : date.getDate()),time.substring(0,2),time.substring(3,5),time.substring(6,8));
//return date.getFullYear();
}

//conversion from the format that our sql table uses to store time to the format that the slider uses to display it
function sqlToSlider(date) {
var formatted = "".concat(date.substring(0,4),"-",date.substring(4,6),"-",date.substring(6,8),"T",date.substring(8,10),":",date.substring(10,12),":",date.substring(12,14),"Z");

return new Date(formatted);
}


//all SQL table fields that we are entering in the table
var fields = new Array("HumidityTemperature","PressureTemperature","Humidity","HumidityHeatIndex","Transducer","PressurePressure","PressureAlititude","Temperature1");
//the field that we use for measuring time in the SQL table
var timeField = "RTCDataTime";
var table;

///////////////////////////// START AJAX FUNCTIONS FOR SQL REQUESTS ////////////////////////////


//used for updating the sensor data in realtime. Asks for the last line of the sql table and then changes the appropriate table columns when done
var currentUpdate = false;
function tableSqlUpdate(field,lines,async) { 
	 currentUpdate = $.ajax({ url: "TableReq.php",
         async: async,
	 type: "POST",
         dataType: 'json',
	 data: {arguments: []}, //no arguments needed for this
         success: function(output) {
	 //for every field, go into the row it represents and change the sensor value and the timestamp
	 for(var i = 0; i < fields.length; i++) {
         var tempData = table.row(i).data();
	 tempData[1] = output[fields[i]];
	 tempData[3] = sqlToTable(output[timeField]); 
         table.row(i).data(tempData); 
	 }
	 finished = true; //check if ajax call is done so we can check before trying another
		    
}
		
});
return finished; //whether or not we have finished retrieving the updated sensor values so we do not call another before the first is finished
}

//calls for the first line of the RTC data time field
function firstTimeQuery(callback) { 
	 ret = null;
	 $.ajax({ url: "FirstTimeReq.php",
         async: true,
	 type: "POST",
         dataType: 'json',
	 data: {arguments: []}, //no arguments needed for this
         success: function(output) {
	 callback(output);
	 
		    
}
		
});
return ret; //return the result of the ajax call
}


//calls for a row that matches or closely matches a specific time and date for the sliders 
function sliderTimeQuery(time) { 
	 ret = null;
	 $.ajax({ url: "SliderReq.php",
         async: true,
	 type: "POST",
         dataType: 'json',
	 data: {arguments: [ time ]},
         success: function(output) {
	 ret = output;
	  //for each field, get the row for it and update the sensor column and the time column
	 for(var i = 0; i < fields.length; i++) {
	 var tempData = table.row(i).data();
         tempData[1] = output[fields[i]];
         tempData[3] = sqlToTable(output[timeField]);  
	 table.row(i).data(tempData); 
	 }
	 $.LoadingOverlay("hide");
		    
}
		
});
return ret; //return the result of the ajax call
}

////////////////////// END AJAX FUNCTIONS ////////////////////////////////////

var doneUpdating = true; //check whether or not our previous ajax call has finished
var updatesPaused = false; //check whether we are in realtime update mode or we have paused it 




//create the table frame and store in a variable for easy changes
  table = $('#sensorsTable').DataTable( {
	"language": {
	"search": "Sensor Select:"

	}
        //"columnDefs": [ {
            //"targets": -1,
            //"data": null,
            //"defaultContent": "<button>Graph readings</button>"
      //  } ]
    } );



$.LoadingOverlay("show");
//variable to store last line of sensor data
var readings = false;

//function called when the ajax call is done
function readingsCallback(result) {
readings = result;
//previously used in the for loop but not anymore
var sensorRows = new Array();
//for loop used to populate each line of the table for each field
for(var i = 0; i < fields.length; i++) {
//var button = document.createElement(i.toString());
//button.type = "button";
//button.className = "btn";
//button.value = fields[i];
//insert a row formatted as: sensor label, current sensor reading, sensor unit, time of reading, and a button to graph the sensor.
table.row.add( [
LABELS[fields[i]],
readings[fields[i]],
UNITS[fields[i]],
sqlToTable(readings[timeField]),
"<button class=graphbutton>Graph ".concat(LABELS[fields[i]],"</button>")
]
).draw(true);

}

//what happens when one of the graph buttons are clicked
$('#sensorsTable tbody').on( 'click', 'button', function () {
        
        var uIndex = table.row($(this).closest("tr")).index(); //get the unsorted row index of the button 
	//store the field that we want to graph in some session storage 
	sessionStorage.setItem('sensor', fields[uIndex]);
	//redirect to the graph page where we are graphing the data
	window.location.href = "lineCharts.html";
        
    } );


//table update loop
setInterval(function(){
if(doneUpdating == true && !updatesPaused) { //if the previous ajax call is done and updates are not paused then we call to update the table
doneUpdating = tableSqlUpdate(fields,1,true);
}
}, 10000); //request to update the table every 10 seconds



}
//start the async call for the table readings  
getFromSql(fields,1,readingsCallback);



//gets the first and last date so we can establish a min and max range for the slider
var firstDate = false;
var lastDate = false;


function firstDateCallback(result) {
firstDate = sqlToSlider(result[timeField]);
getFromSql(timeField,1,lastDateCallback);
}

var currentTime;
var currentDate;
function lastDateCallback(result) {
lastDate = sqlToSlider(result[timeField]);
//default time is midnight
currentTime = "00:00:00"; 
currentDate = new Date(firstDate.getTime() + Math.floor(firstDate.getTimezoneOffset()*60*1000));
  $(function() {
    $( "#slider-range" ).slider({
      range: false,
      //min and max is the first and last date in millis from 1970 but with the added timezone offset
      min: firstDate.getTime() + Math.floor(firstDate.getTimezoneOffset()*60*1000),
      max: lastDate.getTime() + Math.floor(lastDate.getTimezoneOffset()*60*1000),
      step: 1, //step 1 millis while scrolling for a more smooth scroll
      values: [firstDate], //default value of the label for slider is the firstdate
      slide: function( event, ui ) {
	//while sliding update the label value
        $( "#amount" ).val( (new Date(ui.values[ 0 ] ).toDateString() )); //+ " - " + (new Date(ui.values[ 1 ] //*1000)).toDateString() );
	//update the current date as we slide
	currentDate = new Date(ui.value ) ;
      },
      //when we stop sliding we stop the current the realtime updates 
      stop : function (event, ui) {
	
	}
    });
    //set the default label for the slider to  the first date
    $( "#amount" ).val(firstDate.toDateString()); 
    // + " - " + (new Date($( "#slider-range" ).slider( "values", 1 //)*1000)).toDateString());
  });

//time slider
$(function() {
    $("#slider-range-hours").slider({
        range: false,
        min: 0, //min and max are in seconds 
        max: 86400,
        step: 1, //step one second per 1 movement
        slide: function(e, ui) {
	    //convert from total seconds to individual hours, mins, seconds
            var hours = Math.floor(ui.value / 60 / 60);
            var minutes = Math.floor(ui.value/60) - (hours * 60);
	    var seconds = ui.value - (minutes * 60) - (hours * 60 * 60);
	    //insert a 0 to each hour, minute, second as a string if it is only 1 long
            if(hours.toString().length == 1) hours = '0' + hours;
            if(minutes.toString().length == 1) minutes = '0' + minutes;
	    if(seconds.toString().length == 1) seconds = '0' + seconds;
	    //update the value of the label as we slide
            $('#hoursmins').val(hours+':'+minutes+':'+seconds);
	    //update the value of the current time as we slide
	    currentTime = hours+':'+minutes+':'+seconds;
        },
	stop: function(e, ui) {
	
	}
    });
//set the time slider to a default value of midnight
$( "#hoursmins" ).val("00:00:00"); 
});

$.LoadingOverlay("hide");
}

firstTimeQuery(firstDateCallback);
 






//function called that resets back to realtime updates
//I would have placed this inside of document ready stuff, but it did not work there, so this has to go outside of that .
function resetTime() {

window.scrollTo(0,0); //scroll to top of page


$.LoadingOverlay("show");
function resetCallback(output) {
//for every field, go into the row it represents and change the sensor value and the timestamp
	 for(var i = 0; i < fields.length; i++) {
         var tempData = table.row(i).data();
	 tempData[1] = output[fields[i]];
	 tempData[3] = sqlToTable(output[timeField]); 
         table.row(i).data(tempData); 
	 }
$.LoadingOverlay("hide");

updatesPaused = false; //this will break the function if we have not already made a updatesPaused variable
}
getFromSql(fields,1,resetCallback);

}

function oldDataReq(){





$.LoadingOverlay("show");


window.scrollTo(0,0); //scroll to top of page
//stop realtime sensor updates if user stops sliding 
	if(currentUpdate != false) {
	currentUpdate.abort();
	
	}
	updatesPaused = true;	
         //get the row data for the current date and time from sql table
	sliderTimeQuery(sliderToSql(currentDate,currentTime));
	
	

}

//end script 
</script>



<!-- Reset button for restarting realtime updates after sliding through data -->
<input type='button' class='resetbutton' id='link_str' value='Reset back to realtime updates' onClick='resetTime()'>

<footer>
website update 7-14-2018 02:52
</footer>

</body>
</html>
